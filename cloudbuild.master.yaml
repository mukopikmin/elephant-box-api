steps:
  - name: gcr.io/cloud-builders/docker
    args: 
      - build
      - -t
      - gcr.io/$PROJECT_ID/$REPO_NAME:$BRANCH_NAME
      - .
  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - gcr.io/$PROJECT_ID/$REPO_NAME:$BRANCH_NAME
  - name: gcr.io/$PROJECT_ID/$REPO_NAME:$BRANCH_NAME
    args: 
      - bundle
      - exec
      - rails
      - spec
  - name: gcr.io/$PROJECT_ID/$REPO_NAME:$BRANCH_NAME
    args: 
      - bundle
      - exec
      - rails
      - rubocop
  - name: gcr.io/cloud-builders/gcloud
    args:
      - kms
      - decrypt
      - --ciphertext-file=credentials/credentials.master.json.enc
      - --plaintext-file=/kms/credentials.master.json
      - --location=global
      - --keyring=refrii-api
      - --key=production
    volumes:
      - name: kms
        path: /kms
  - name: gcr.io/$PROJECT_ID/$REPO_NAME:$BRANCH_NAME
    entrypoint: sh
    args:
      - scripts/migrate.sh
      - $BRANCH_NAME
    volumes:
      - name: kms
        path: /kms
    env:
      - RAILS_ENV=production
      - RACK_ENV=production
    secretEnv:
      - MYSQL_SOCKET
      - MYSQL_DATABASE
      - MYSQL_USERNAME
      - MYSQL_PASSWORD
      - SECRET_KEY_BASE
  - name: gcr.io/cloud-builders/gcloud
    entrypoint: sh
    args: 
      - scripts/deploy.sh
      - refrii-api-production
      - gcr.io/$PROJECT_ID/$REPO_NAME:$BRANCH_NAME
    env:
      - RAILS_ENV=production
      - RACK_ENV=production
secrets:
  - kmsKeyName: projects/refrii-169906/locations/global/keyRings/refrii-api/cryptoKeys/production
    secretEnv:
      MYSQL_SOCKET: CiQAupArw1bnpfLHlOwKVnS6h7YIAP0Vl3o8kxm+EWri+pJ6N/sSWAD/p2USYbChqgURanchU5XKkZ1gBDqzq4QdkTqsueZAGkYAhiU18JHrYfHldSopYzhOxoz4VOEMxOidy1KihSuRNa7vCS0Z6IbN0kqLHvV2xWeRhZ+5WJE=
      MYSQL_DATABASE: CiQAupArw/fK9Nip+n6LvYL2SUgPPUblXj8qIUT7vIVPU3zsrrsSOwD/p2USDhiWSrZA7A8wM/ohfZ1nHVfOZZlNcdXpT38Td5Qu6ahVkQpxasoEDlSfs08kC4RzhvfpfWoC
      MYSQL_USERNAME: CiQAupArwzIrk9hzhRPEeCmcuij98kFQZLjrdzzIaba5xiDGdRcSLgD/p2USYlQbngAgGF39LYMs3voTnMTLC5fSYEqEboGbO6oS8kqNGf2zX07yJ/8=
      MYSQL_PASSWORD: CiQAupArw9KfeoAJTXRga121BBh53t1TnH58xeRBUQtUMX1uAMISOgD/p2USOt1NkJfro6ZVzM/qxnGt1FZ9cUEil3EnDnsjSA2TQryz7CjxTcpxBsNJz06KLSy2ISkRJN4=
      SECRET_KEY_BASE: CiQAupArwxsqiomrEZgs2xtkDWukISTDtbQhMIxg7RxTttlyacISqwEA/6dlEsgU5E85nezRz8srm5QsIaqkaY9VwgzarutfKXy6huDey6K4tmGmdRoB4wY0W1TpC9vd5ncoPCEFRn+c6fGNnyBj3ldWeFDzx6MK/Onaobti7db7odnREtlc5OzM7p+py1p8vcq6paMBCGO8vjxWAVqPJD7I9zKjedT3aBhArQmNU4m34uMU8T17XdLAKXQZbyLs2tFBHDcNNtytQV7BiAVgiN3WJlY=
images:
  - gcr.io/$PROJECT_ID/$REPO_NAME:$BRANCH_NAME
